{% extends 'base.html' %}

{% block content %}
<h2>Plywood Department</h2>

<div class="filter-container">
    <!-- Assembly Status Filter Form -->
    <label> Assembly Status (built, waiting)</label>
    <form method="get" action="." class='filter-form'>
        <select name="assembly_status" onchange="this.form.submit()">
            <option value="all">All Assembly Statuses</option>
            <option value="Built" {% if assembly_status_filter == 'Built' %}selected{% endif %}>Built</option>
            <option value="Waiting" {% if assembly_status_filter == 'Waiting' %}selected{% endif %}>Waiting</option>
        </select>
        <!-- Retain the value of the other filter -->
        <input type="hidden" name="picking_status" value="{{ picking_status_filter }}">
    </form>
    
    <!-- Sorting Filter Form -->
    <label> Sort by (most recent, oldest) </label>
    <form method="get" action="." class="filter-form">
        <select name="sort_order" onchange="this.form.submit()">
            <option value="newest" {% if sort_order == 'newest' %}selected{% endif %}>Most Recent</option>
            <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Oldest</option>
        </select>
        <!-- Retain the values of the other filters as hidden fields -->
        <input type="hidden" name="assembly_status" value="{{ assembly_status_filter }}">
      
    </form>


    <form method="get" action="" class="search-form">
        <input type="text" name="search" placeholder="Search term" value="{{ search_query }}">
        <input type="submit" value="Search">
        <input type="submit" name="clear" value="Clear">
    </form>
    


</div>





<table>
    <thead>
        <tr>
            <th>Order Number</th>
            <th>Product Code</th>
            <th>Delivery Postcode</th>
            <th>Product Description</th>
            <th>Workshop Notes</th>
            <th>Assembly Status</th>
            
            <!-- Add more headers if needed -->
        </tr>
    </thead>
    <tbody>
        {% for workshop in page_obj %}
        <tr>
            <td class="searchable">{{ workshop.sage_order_number.sage_order_number }}</td>
            <td class="searchable">{{ workshop.product_code.product_code }}</td>
            <td class="searchable">{{ workshop.sage_order_number.delivery_postcode }}</td>
            <td class="searchable">{{ workshop.product_code.product_description }}</td>
            <td>
                <div class="notes-container">
                    <form method="post" action="{% url 'update_workshop_notes' workshop.id %}">
                        {% csrf_token %}
                        <textarea name="workshop_notes" class="autoresize" placeholder="Add notes here">{{ workshop.notes|default_if_none:"" }}</textarea>
                        <input type="hidden" name="workshop_id" value="{{ workshop.id }}">
                        <input type="submit" value="Save" class="save-btn">
                    </form>
                </div>
            </td>
            <!-- Assuming you can access the picking status from workshop or related order/part -->
            <td>
                <div class="filter-form">
                    <form data-workshop-id="{{ workshop.id }}">
                        <select name="assembly_status" class="assembly-status-selector">
                            <option value="Built" {% if workshop.assembly_status == 'Built' %}selected{% endif %}>Built</option>
                            <option value="Waiting" {% if workshop.assembly_status == 'Waiting' %}selected{% endif %}>Waiting</option>
                            <option value="In Progress" {% if workshop.assembly_status == 'In Progress' %}selected{% endif %}>In Progress</option>
                        </select>
                    </form>
                </div>
            </td>
            
            
        
        </tr>
        {% endfor %}
    </tbody>
</table>



<div class="pagination-container">
    {% if page_obj.has_next %}
        <form method="get" action="">
            <!-- Retain current filters as hidden fields -->
            <input type="hidden" name="assembly_status" value="{{ assembly_status_filter }}">
            
            <!-- Increment the number of items displayed -->
            <input type="hidden" name="num_items" value="{{ page_obj.paginator.per_page|add:20 }}">
            
            <!-- Show More button -->
            <button type="submit" id="show-more">Show More</button>
        </form>
    {% endif %}
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>



    $(document).ready(function(){
        var searchTerm = '{{ search_query|escapejs }}';
        if(searchTerm) {
            $("td.searchable").each(function(){
                var text = $(this).text();
                var regex = new RegExp('('+searchTerm+')', 'gi');
                $(this).html(text.replace(regex, "<span class='highlight'>$1</span>"));
            });
        }
    });



    document.getElementById('show-more').addEventListener('click', function() {
        localStorage.setItem('scrollPosition', window.scrollY || document.documentElement.scrollTop);
    });

    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('scrollPosition') !== null) {
            window.scrollTo(0, localStorage.getItem('scrollPosition'));
            localStorage.removeItem('scrollPosition');
        }
    });



    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.assembly-status-selector').forEach(function(select) {
            select.addEventListener('change', function() {
                const form = this.closest('form');
                const workshopId = form.getAttribute('data-workshop-id');
                const selectedStatus = this.value;

                fetch(`/management/update-assembly-status/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 'workshop_id': workshopId, 'assembly_status': selectedStatus })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Response received:", data); // Debugging
                })
                .catch(error => {
                    console.error("Error:", error); // Debugging
                });
            });
        });
    });

    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            let [key, value] = cookie.trim().split('=');
            if (key === 'csrftoken') {
                return value;
            }
        }
        return '';
    }
</script>





{% endblock %}
