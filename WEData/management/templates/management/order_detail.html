{% extends "base.html" %}
{% load humanize %}

{% block content %}
    <h2>Order Number: {{ order.sage_order_number }}</h2>

    <div class="order-details-container">
        <table class="order-details-table">
            <!-- Order Details -->
            <tr>
                <th>Customer</th>
                <td>{{ order.customer.name }}</td>
            </tr>
            <tr>
                <th>Order Date</th>
                <td>{{ order.order_date }}</td>
            </tr>
            <tr>
                <th>Delivery Postcode</th>
                <td>{{ order.delivery_postcode }}</td>
            </tr>
            <tr>
                <th>Order Value:</th>
                <td>Â£ {{ order.value|intcomma }}</td>
            </tr>

            <tr>
                <th>Codes:</th>
                <td>
                    {% if codes %}
                        <table class="order-details-table">
                            {% for code in codes %}
                                <tr>
                                    <td >{{ code.code }}</td>
                                    <td >{{ code.label }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    {% else %}
                        <p>No codes available.</p>
                    {% endif %}
                </td>
            </tr>





            <!-- Add more rows as needed -->
        </table>
        <!-- Add more fields as needed -->
    </div>

    <h3>Order notes</h3>
    <div class="notes-container">
        <form method="post" action="{% url 'update_order_notes' %}">
            {% csrf_token %}
            <textarea name="user_notes" class="autoresize" placeholder="Add notes here"></textarea>
            <input type="submit" value="Save" class="save-btn">
            <input type="hidden" name="order_id" value="{{ order.sage_order_number }}">
        </form>
    </div>

    <h3>Parts in this Order</h3>
    <table>
        <tr>
            <th>Product Code</th>
            <th>Product Description</th>
            <th>Department</th>
            <th>Job Number</th>
            <th>8mm Status</th>
            <th>18mm Status</th>
            <th>Picking Status</th>
            <th>Assembly Status</th>
            <th>Comments</th>
            

        </tr>
        {% for part in parts %}
        <tr>
            <td>{{ part.product_code.product_code }}</td>
            <td>
                {{ part.product_code.product_description|default:"Description not available" }}
            </td>
            <td>{{ part.dept }}</td>

            
            <td class="{% if part.dept.lower != 'assembly' %}status-complete
                        {% elif not part.job %}status-waiting
                        {% endif %}">
                {% if part.dept.lower == 'assembly' and part.job %}
                    <a href="{% url 'job_detail' part.job.job_id %}">{{ part.job.job_name }}</a>
                {% elif part.dept.lower == 'assembly' and not part.job %}
                    <div style="background-color: inherit;">&nbsp;</div>
                {% else %}
                    <div style="background-color: inherit;">&nbsp;</div>
                {% endif %}
            </td>

            
            
            <td class="{% if part.department != 'Assembly' %}status-complete
                        {% elif part.job.mm8_status == 'Machined' %}status-complete
                        {% elif part.job.mm8_status == 'On Hold' %}status-other
                        {% elif part.job.mm8_status == 'Waiting' %}status-waiting
                        {% else %}status-other{% endif %}">
                {% if part.department == 'Assembly' %}
                    {{ part.job.mm8_status|default:"" }}
                {% endif %}
            </td>





            <td class="{% if part.department != 'Assembly' %}status-complete
                        {% elif part.job.mm18_status == 'Machined' %}status-complete
                        {% elif part.job.mm18_status == 'On Hold' %}status-other
                        {% elif part.job.mm18_status == 'Waiting' %}status-waiting
                        {% else %}status-other{% endif %}">
                {% if part.department == 'Assembly' %}
                    {{ part.job.mm18_status|default:"" }}
                {% endif %}
            </td>







            {% with job_picking_status=part.job.pickingprocess_set.first.picking_status|default_if_none:"" %}
                <td class="{% if part.department != 'Assembly' %}status-complete
                            {% elif job_picking_status == 'Picked' or part.picking_status == 'Picked' %}status-complete
                            {% elif job_picking_status == 'On Hold' or part.picking_status == 'On Hold' %}status-other
                            {% elif job_picking_status == 'Waiting' or part.picking_status == 'Waiting' %}status-waiting
                            {% else %}status-other{% endif %}">
                    {% if part.department == 'Assembly' %}
                        {% if job_picking_status %}
                            {{ job_picking_status }}
                        {% else %}
                            {{ part.picking_status|default:"" }}
                        {% endif %}
                    {% endif %}
                </td>
            {% endwith %}



            <td class="{% if part.dept|lower == 'upholstery' %}
                        {% if part.upholsteries.first.assembly_status == 'Waiting' %}status-waiting
                        {% elif part.upholsteries.first.assembly_status == 'On Hold' %}status-onhold
                        {% elif part.upholsteries.first.assembly_status == 'Printed' %}status-printed
                        {% elif part.upholsteries.first.assembly_status == 'Cut' %}status-cut
                        {% elif part.upholsteries.first.assembly_status == 'Sewn but needs filling (48 hrs)' %}status-sewn-needs-filling
                        {% elif part.upholsteries.first.assembly_status == 'Sewn but needs frame (48 hrs)' %}status-sewn-needs-frame-48hrs
                        {% elif part.upholsteries.first.assembly_status == 'Sewn but needs frame (5 Days)' %}status-sewn-needs-frame-5days
                        {% elif part.upholsteries.first.assembly_status == 'Sewn but needs frame (10 days)' %}status-sewn-needs-frame-10days
                        {% elif part.upholsteries.first.assembly_status == 'Goods Ready' or part.upholsteries.first.assembly_status == 'Built' %}status-complete
                        {% else %}status-other
                        {% endif %}
                    {% else %}
                        {% with workshop=part.workshops.first %}
                            {% if workshop.assembly_status == 'Built' %}status-complete
                            {% elif workshop.assembly_status == 'On Hold' %}status-onhold
                            {% elif workshop.assembly_status == 'Waiting' %}status-waiting
                            {% else %}status-other
                            {% endif %}
                        {% endwith %}
                    {% endif %}">
                {% if part.dept|lower == "upholstery" %}
                    {{ part.upholsteries.first.assembly_status|default:"N/A" }}
                {% else %}
                    {% with workshop=part.workshops.first %}
                        {{ workshop.assembly_status|default:"N/A" }}
                    {% endwith %}
                {% endif %}
            </td>
            
            <td>
                {% if part.dept.lower == "upholstery" %}
                    {{ part.upholsteries.first.comments|default:"" }}<br>
                    {{ part.upholsteries.first.comment2|default:"" }}
                {% else %}
                    {{ part.sage_comment1|default:"" }}<br>
                    {{ part.sage_comment2|default:"" }}
                {% endif %}
            </td>


        </tr>
        {% endfor %}
    </table>
    
{% endblock %}

{% block javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.autoresize').forEach(function(textarea) {
                function resizeTextarea() {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }
                textarea.addEventListener('input', resizeTextarea, false);
                resizeTextarea(); // Initialize size
            });
        });
    </script>
{% endblock %}
